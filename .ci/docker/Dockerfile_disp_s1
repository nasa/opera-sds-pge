# Dockerfile to produce the production DISP-S1 PGE Docker image for OPERA
# Authors: Scott Collins, David Inglish

# Default SAS image path, must be provided by the docker build call via --build-arg
ARG SAS_IMAGE
FROM $SAS_IMAGE

ARG PGE_SOURCE_DIR
ARG PGE_DEST_DIR=/home/mamba
ARG CONDA_ROOT=/opt/conda

ENV PGE_DEST_DIR=$PGE_DEST_DIR
ENV CONDA_ROOT=$CONDA_ROOT

ARG BUILD_DATE_TIME
ARG BUILD_VERSION

# labels
# the label-schema convention: http://label-schema.org/rc1/
LABEL org.label-schema.build-date=${BUILD_DATE_TIME} \
  org.label-schema.version=${BUILD_VERSION} \
  org.label-schema.license="Copyright 2023,\
 by the California Institute of Technology.\
 ALL RIGHTS RESERVED.\
 United States Government sponsorship acknowledged.\
 Any commercial use must be negotiated with the Office of Technology Transfer\
 at the California Institute of Technology.\
 This software may be subject to U.S. export control laws and regulations.\
 By accepting this document, the user agrees to comply with all applicable\
 U.S. export laws and regulations. User has the responsibility to obtain\
 export licenses, or other export authority as may be required, before\
 exporting such information to foreign countries or providing access to\
 foreign persons." \
  org.label-schema.name="OPERA Product Generation Executable (PGE) Image" \
  org.label-schema.schema-version="1.0" \
  org.label-schema.vendor="California Institute of Technology" \
  org.opencontainers.image.source="https://github.com/nasa/opera-sds-pge" \
  maintainer="California Institute of Technology"

# Copy the OPERA PGE software into the container
# the base container has a default user "mamba" with UID/GID 1000/1000
COPY --chown=mamba:mamba ${PGE_SOURCE_DIR} ${PGE_DEST_DIR}

# Switch to root for installing into Conda Env
USER 0:0

# Install dependencies into existing Conda Env
# TODO: remove last chmod once permissions are set correctly on /home/mamba for delivered containers
RUN set -ex \
    && cd ${PGE_DEST_DIR} \
    && mkdir -p ${CONDA_ROOT}/bin \
    && cp ${PGE_DEST_DIR}/opera/scripts/*_entrypoint.sh ${CONDA_ROOT}/bin \
    && chmod +x ${CONDA_ROOT}/bin/*_entrypoint.sh \
    && source /usr/local/bin/_activate_current_env.sh \
    && ${MAMBA_EXE} install --yes --channel conda-forge --file ${PGE_DEST_DIR}/opera/requirements.txt \
    && chmod 775 ${PGE_DEST_DIR} \
    # Create a separate conda environment for the eccodes install needed to run grib_to_netcdf
    && ${MAMBA_EXE} create -n eccodes \
    && ${MAMBA_EXE} install -n eccodes --yes --channel conda-forge eccodes jpeg \
    # Install grib_to_netcdf and make it available to the eccodes conda env
    && curl -o /tmp/eccodes-2.28.1-1.x86_64.rpm https://artifactory-fn.jpl.nasa.gov:443/artifactory/general/gov/nasa/jpl/opera/sds/pge/disp_s1/eccodes/eccodes-2.28.1-1.x86_64.rpm \
    && dnf install -y /tmp/eccodes-2.28.1-1.x86_64.rpm \
    && rm -rf /tmp/eccodes-2.28.1-1.x86_64.rpm \
    && ln -sf /opt/eccodes/bin/grib_to_netcdf /opt/conda/envs/eccodes/bin/

# Set the Docker entrypoint and clear the default command
ENTRYPOINT ["sh", "-c", "source /usr/local/bin/_activate_current_env.sh;exec ${CONDA_ROOT}/bin/pge_docker_entrypoint.sh \"${@}\"", "--"]
CMD []

# Set the user/group back to the default
USER mamba:mamba

